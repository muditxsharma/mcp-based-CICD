services:
  api:
    build: ./apps/api
    env_file:
      - ./.env
      - ./apps/api/.env.example
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - mcp_github
      - mcp_docker
      - mcp_k8s
    volumes:
      - ./audit:/app/audit
      - ./policies:/app/policies
      - ./workflows:/app/workflows
      - ./bundles:/app/bundles

  web:
    build: ./apps/web
    env_file:
      - ./.env
      - ./apps/web/.env.example
    ports:
      - "5173:5173"
    depends_on:
      - api

  mcp_github:
    build: ./mcp/github_server
    env_file:
      - ./.env
    ports:
      - "9101:9101"

  mcp_docker:
    build: ./mcp/docker_server
    env_file:
      - ./.env
    ports:
      - "9102:9102"
    depends_on:
      - registry

  mcp_k8s:
    build: ./mcp/kubernetes_server
    env_file:
      - ./.env
    ports:
      - "9103:9103"
    volumes:
      - ~/.kube:/kube:ro

  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: mcp
      POSTGRES_PASSWORD: mcp
      POSTGRES_DB: mcp
    ports:
      - "15432:5432"   # ✅ changed (host:container)
    volumes:
      - pgdata:/var/lib/postgresql/data

  registry:
    image: registry:2
    ports:
      - "15000:5000"   # ✅ changed (host:container)
    volumes:
      - registrydata:/var/lib/registry

volumes:
  pgdata:
  registrydata: